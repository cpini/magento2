steps:
- name: 'gcr.io/cloud-builders/docker'
  entrypoint: 'bash'
  args: [
    '-c',
    #'docker build -t eu.gcr.io/$PROJECT_ID/magento2-apache24:latest -f k8s-config/apache-docker/Dockerfile --build-arg WEB_SSL_KEY=$$SSL_KEY --build-arg WEB_SSL_CRT=$$SSL_CRT --build-arg WEB_SSL_PEM=$$SSL_PEM .'
    'docker build -t eu.gcr.io/$PROJECT_ID/magento2-apache24:latest -f k8s-config/apache-docker/Dockerfile --build-arg WEB_SSL_CRT=$$SSL_CRT .'
    ]
  #secretEnv: ['SSL_KEY','SSL_CRT','SSL_PEM']
  secretEnv: ['SSL_CRT']
- name: 'gcr.io/cloud-builders/docker'
  args: ['push', "eu.gcr.io/$PROJECT_ID/magento2-apache24:latest"]
images: ["eu.gcr.io/$PROJECT_ID/magento2-apache24"]

# echo -n $path_to_enc_file | gcloud kms encrypt --plaintext-file=- \
#   --ciphertext-file=- --location=global --keyring=$keyring-name \
#   --key=$key-name | base64
secrets:
# - kmsKeyName: "projects/magento2-269418/locations/global/keyRings/magento-web-secrets/cryptoKeys/magento-webserver"
#   secretEnv:
#     SSL_KEY: CiQAwLhXnYlnR9B+OjcU1r49DF8VqzIQDgWEZayVwSYtzGjkCpASYADjhmPvdzQE1zmvxQTZA2scCqmWaiwNDZQtin0JfCpE+JxUmzK90+xlYcpcpCyD0s5LSYXQGRTzNqV4+5pno7+ERmfRPR7QLR4gbjRmzsGInQLmcyeFeNJwV/zmHh2pwg==
- kmsKeyName: "projects/magento2-269418/locations/global/keyRings/magento-web-secrets/cryptoKeys/magento-webserver-new-cert"
  secretEnv:
    SSL_CRT: CiQA4UGEtA3bhuFriLJrzJElcUXk01RzMH+gLKtwe08xCcNkDSMS+wkAwGvbDh+20vBgPuwtd9GETq2hfC0n81b5b41nYyoqwKD+m4bAl6mNBsShMcjLrF/vtpgGVvRW6dGm6FwtE3V6RW0wVndOhN4sLrqow3fsp36d5wN9fBo3IACRiYONjsI4hX8IYSl+tGmg9hkniN4YIAv1AbhQ4AQrEO7PxAit9/xwHWSBTXBxzSElsmv9E2VflO6HWMSZ/cNFaIQrKm0MmpuJX6/iKRFhdnLo05r3S2dwfiYju/OoZCP4tFGSoJrMbpGPsjKEWB6cnkqzl88yNxHKsO2nUBpZEpRudCNAsZgwQCLckxQRDViOlNXuR5mVL5k6M7tWDPmocFtVtXkdwxZUfCLXXF8psvpigE91GATCIXRFNLLyKkxQtG+j3oBG1f4R3uHVXVsUqS16tXmvV9ouDMf7d10ftAKpyL3HOO7tqrGY4Ms+PtLTJrDJgFgTpPEBlZwCpDClP7aI0WaCSK4e4LKLQKOFi9RDApm8WOfAlqn7oBNVzLfEPLRJlLRO+PEac4AlW4MpjLYQvaEq1uMaA4EG0jnM3I6uZI58itfLKO11y29a3e0OknTbh/Des9UlaebHzv9V8s2yELEFEjZfOGqIo//XbXLBB/2yZOE7bnc8dKAf+CAXXZGqwx1XU/4uZuaRsCYoSxlI5ylPWQfoD6zud7HPdAd3JP5OJL9/9L8RZ4QuDd7+Y8k+IMwMHlUlcMJr1TF8jvCkneFIzln8mwgVhTdKxoZUesQEx/J99oTp0A5jl2dc3GRdcP9FbjHsS/kL7Q9xVdEwLpOP0euCebxLndatwRNbyGSUNXYHHBc4pDOsZbavChBvn99VzFeR+dquGJlOIUu+wpIUva/ROOhodrYfGsYyLcXsV/IqPiNN62xz+AognHtOPHvzIPxH87q2f5O/EY7vVuZZx4b02O7mnzRkZNj5DhH030bXW6Kvzdmo8ZIKB3ZTksnJpDm6AnoM2Xy7OdZ5lG3oqIS05VHi4MbF+Q0Yb2rg367t2OewBDWoWlf0PLv3RDqv9iWuUyxCtpwbafnSN2zj0fK1FTp3S6VPykD/QIAxsTWzteLUDi8n+r0Eqd4iT30ROWU6YdI2Mqpf2BLLuLSMavRk1bemAQoOesBaiMkKxlxZxQRg4IQqy9kcWc8P6yZXm+p75KUFX/bECeKnuctaQApoqC2FAtOyZXsm6zdgIC6rJhJ+D+aPcEAbVF+u7G66nxusK8gHdomh/HWqY4UsS/c08hAQ9XyaTv8TxsZM9WpoG9byO9qlrKCEhVTw3oCJJ9wj0DrxLL9cJEhnMJxk5tQigdl1i8om5IZBhvzwk6VvgXpj5NHp6BodQ/EzxbpR9yDxS/MdQrGtWw73awXfbUCDHy15+hHjys5+Mvgrc0pfTYP0xe6+T+FMZTDbSJIyOZNktQmmTzDZookB+gpy8B3vwSOFiW1Uzd3lwRfNIrnzr46EM2Qo1VbaFKu3PQYzfgua7crsxmJ0R7HenBRNUpuSEE9TDSqM+dRVGLMVQVYM6HryUT9u1nLIocml2s7if66WpJKYiD8lL7CJbRe6zK9La08pG7W9OvSxNhJKme6lswinOzlWEaC5fLk2MzQRbO/vBEnbNw7MIQaRlal4jJ+a1Q/FwydumXo87fASa1haM/tqn4uhnGhOZrG326ffKL69c/PiK0uExDnsQMinrMH4z7xDSA1IKIA=