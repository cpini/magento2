steps:
- name: 'gcr.io/cloud-builders/docker'
  entrypoint: 'bash'
  args: [
    '-c',
    'docker build -t eu.gcr.io/$PROJECT_ID/magento2-apache24:latest -f k8s-config/apache-docker/Dockerfile --build-arg WEB_SSL_CRT=$$SSL_CRT .'
    ]
  #secretEnv: ['SSL_KEY','SSL_CRT','SSL_PEM']
  secretEnv: ['SSL_CRT']
- name: 'gcr.io/cloud-builders/docker'
  args: ['push', "eu.gcr.io/$PROJECT_ID/magento2-apache24:latest"]
images: ["eu.gcr.io/$PROJECT_ID/magento2-apache24"]

# echo -n $path_to_enc_file | gcloud kms encrypt --plaintext-file=- \
#   --ciphertext-file=- --location=global --keyring=$keyring-name \
#   --key=$key-name | base64
secrets:
# # - kmsKeyName: "projects/magento2-269418/locations/global/keyRings/magento-web-secrets/cryptoKeys/magento-webserver"
# #   secretEnv:
# #     SSL_KEY: CiQAwLhXnYlnR9B+OjcU1r49DF8VqzIQDgWEZayVwSYtzGjkCpASYADjhmPvdzQE1zmvxQTZA2scCqmWaiwNDZQtin0JfCpE+JxUmzK90+xlYcpcpCyD0s5LSYXQGRTzNqV4+5pno7+ERmfRPR7QLR4gbjRmzsGInQLmcyeFeNJwV/zmHh2pwg==
- kmsKeyName: "projects/magento2-269418/locations/global/keyRings/magento-web-secrets/cryptoKeys/magento-webserver-new-cert"
  secretEnv:
    SSL_CRT: CiQA4UGEtJDFZrOvAfCN3EYugxW2VOAnq+jcHYCzdpY8mk2LLYUS+wkAwGvbDoagWxI30x+KYD/+JK5FoiDlRIjwflfJhANDz4XglR3Sny1UZ+zDV12pFp/oGcmWeQM08xZmHb18BY3raLRXARrVLWEXmUc5zox/2QQUwMyannarw2V3jYiOq7mX+fINhhmuQwuJm4efSG/ycTXf4iQWEE25Q+gwiapdZrsXNCUtyRFdtNU9m6npKIx7rtEawm0/nvdo65Aj65IhDA5GBqxpEe+xeXYgKigBlGXqNJcJB0zSfHqnl0r5mcIOjKhmBnGoqosQXVMeNkpI68SYX3cf3wWKLHika4Te2+ymne0o/RIJMwouPyL/JEWnyP5IDHjMIK7oG9fE8kQzg/Nt9P5Zb5Aezs/962EKYF3CyRXx8ZkxJ2WcwU8fvAPw9tY9KPBtrKAUPu1e1a0ctB5MQz3ai3dTXCzD2NFd4Ai3Hied9tDedX26f7rRJV1XVE+XNlcVUHvZWWHTNQKmgg8inKm0VJVuOFtXA3pwsfF609TwF3an+c9k1Dy1YBxZUQlk/8q1hV9VuwIXGOmgYfcKxbWjSMiP70/DJwjPQPa3qYU5mAiwh1urSgNovnyi5T0qXfT5FWYpX6fIgvlp13p8nSnQzEv9dSuSDe5U6dCZ7YRt3owLMGUB0jJU9mIzbAqD8BIVxSH53/E81uTGbOcDWBHQGUXNV4htA12Tx/htpUzIuKPRgiJphAURtJPDhyMvPgyYEZrDTBfI1rla3szE4C20kpJdk+m+Jp9tfqWe+k2nmE4QP0CBD//3g4GwkYThkctR86LZBOGBkXtGU9XHsKq45M8pFt9+aMAro8pvBhuLlq0imQbz3jlELtboQrD7WsSXWmtjmVjnYeX4wYEeOUtFlR7QGm2sdjNMkRQNhvYDINiMFlNJ4NiDi2Yt7McIm+zVTBqaY6RT8s8Ko0jlxVzIgShF8dN0GSop5ENSv097Ti2tLFk/z248yg82cnaqzEF3tbRPy63Eyzx5ng60J00HH539vaCtmhLilz2d2DtThQNWgy+x3/k74IZFIqm1hetD5vpTrNTmOcrrEjuAJnVcHixJ+esL7jFCXPTkugEn/nSydiNwqqsOl/is/FZYMBhdSor9RgEd9h4k7GYtC8/qIx4zdP5K8u30k76kC/6OyuKhpfHALM+tZP96GBmpssRxf1/7hxD+RpqqzYwOc4/rqVuguMuHSu73jtQHjQu4WWewfKQ1/LRHe4YL0Obzj1QRy7n3itY2p5gCHXWvaoV6gerpXJGunlgOgtyQ7uIJEueSPmf8zIMn+2tpc4luDM7MGUou9L2amtMZxHG4Vr9L5incPcklSCuAhZuIo3LENl+aV6H2Yrni4dVwA2lqj8IKxBkahu96skWaTuzZwVLkJSan7+WdukRY3bTFZP7XpqbEF8Nio/1sA+jian8NJP3xdsLDqChPcuq0AUi+BNlnXX4n7v6KhrvrfrZGrT+4BIdu+sfahB9lHvuWbDcCWn2rrTwFgU3sXI9e3HT8xGylFaawGfiseTnuX/owVDfiFM6LlpH2PqxxhmeyNakaucSD/R+rJeI7HEbfnC+fhQ8Ie9wLGqAwBHo57fXA66sHlN8sBN3FqguzqCg9mllPJjk+QMjH3bfXYM+jaUNE+rctAYWrdOjXwOYXLvUwJ1W+XXZqUBGf9Sa+9i8Pk1C+odsZrIYazeY6leViOxs0E2NTO4NWwh0=