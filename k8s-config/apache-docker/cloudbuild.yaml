steps:
- name: 'gcr.io/cloud-builders/docker'
  entrypoint: 'bash'
  args: [
    '-c',
    'docker build -t eu.gcr.io/$PROJECT_ID/magento2-apache24:latest -f k8s-config/apache-docker/Dockerfile --build-arg WEB_SSL_KEY=$$SSL_KEY --build-arg WEB_SSL_CRT=$$SSL_CRT --build-arg WEB_SSL_PEM=$$SSL_PEM .'
    ]
  secretEnv: ['SSL_KEY','SSL_CRT','SSL_PEM']
- name: 'gcr.io/cloud-builders/docker'
  args: ['push', "eu.gcr.io/$PROJECT_ID/magento2-apache24:latest"]
images: ["eu.gcr.io/$PROJECT_ID/magento2-apache24"]

# echo -n $path_to_enc_file | gcloud kms encrypt --plaintext-file=- \
#   --ciphertext-file=- --location=global --keyring=$keyring-name \
#   --key=$key-name | base64
secrets:
- kmsKeyName: "projects/magento2-269418/locations/global/keyRings/magento-web-secrets/cryptoKeys/magento-webserver"
  secretEnv:
    SSL_KEY: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFb2dJQkFBS0NBUUVBeDJnejRadU1sTmF1YkhPRlMxSzMyQjRINUZ2QWoyWW1VNFJlZE9MRXlqRzMwTGVvCjdFazFEcWh2WEh2UHNCVG9tUkhhZ1RKdkl2dFk2VXltSG9USXBzdUgwMmVoQm5Kcm5vVlhxUjZ0blA1VTBMMkQKd3A1bExLaEVHaGZxMmhLS3RSUGJHV1pqOUlQd3hZYlJ0Rk5ReHNUWnNhWWlHNEdPTndINnVJMHJONE9WSExsVgpzRzlBMDBFZE9RSEZaQWgxb2h1Qmc1UHhDOXJCZHF3WFhSSEY1QlZYYVB2bjRidW9Xa3pHMWFvczJySWxORTZoCmZFV0tBbldPWGEwQVZRUW9ySnkzMUFPdnlScTFtWFM4MG9qbFJ3UVByKzJzVkVRTWRjNXZMTGxkc2NRU294UTYKU3Z4M282RkJaUXhMTnVzRW8reDZXV2owQ084S2x0L3R4NmJjUVFJREFRQUJBb0lCQUVZR0c2SHdJNi9vcTV1OQovV0wwQzBkRFZIWW1tanBCSHRoWk5XcEtiOXlwRk9tZ2RSdDBvY01oOXVrOU9UT1dSQS9zcXhTUGgyTjdiRCtSCkFRemFpRE82YVZvZG0vaE5tZWt5M2hPdmlEd0hPL1dKZDRtU1lla0t0YytMOHBiZHlBUEtremdhTXFPYzZhSVQKcy9SbEJZcW5lZUxlZWorNmdSeGovNDFyVlcvS2tJMzBESXcrNzI4TFdTWDd3a0MvSTJWOU5IRGFwSmJLL0p6VwpxSlM0QTdYWi9obWxXancvc0VSUm9pVEZZRUFqcms4anAxTUdsUlV5dXBML2pVTFJMT3h4L1JxVi9sZUdYK2E0CkFLQ2VTeThFKzIvTDB6bWMyc2FubmlqWWVqbHY1ZUs4NHA1OGZieG5heGNkL2NLR1VrRS9xczM1VlBHczM5SVAKTmNQU25Ca0NnWUVBNWtydi8zZlhPclBoYzRXSEhGNFViWkV3UmhiOGVveDVyZE9SaEFUM3JnUmNvMFQ2ckM1NQp1MEo4ZjN0MEZmby9EKzVrRkN0ZmFNSVdocEJRN0gwckllcUZUVFhiZ1pQMnU1V3lLcXY0TGw3T3FoM0hBZnFjCkVic2ZPQXR6a0d5cFZ0d3RRSU04bTBjZFVQMXJZWmFtZ0JwbDMwU2d5UWFzWXdlbk9WTi8xUWNDZ1lFQTNhcWwKanJuYlIvbVJHQ1R1TUNBcTJPckNEWmdTdUNJcTZUeFVTcVdWTHRXclJFNnVhR0NXV1ZrekdLRGxlZGFZUU41bQpXbTNHNm1vSzVNUURyNTFtTUVhaGdybytQVkdob3NzQ0dDT3ZaVSsrN0xiNmcrOXlVSVU0UC9UK1R5eE1HNXlECk5CNm9UR09Ud3picXlVWFBJZFNpTnRFRDJPMWZSU3ZnTDBxKytuY0NnWUJBQzRNbk52cmlWbmhTbWtYeSs2OE8Kc1p3TlFnTkJTYVBsVmJ0WVRkRmIwZGE1aVV0MWF3OXJwcGZkRkVZNmZuZmZSRnNNeU9zbHhTUmlrK3dOZU5udgorcnJMdURpdGxxcTlqR29hTiswemFDWnRaUTZkWEViZkgzMFZKd29pbGpXWjlHMlpUV1lqZ09tRVJwWUFjOWNtCk5URXpvSEJldDc1bFpCRjdmZDlGTFFLQmdHa21PY0txaDBwdEtGYTdyZ0ZHUVEwRXoyaURhdDNOMTIwc0lSQUgKMit5TGp1S29NRE56SGQ3a1lVaWRpajF4Zm1mSEYrWnRqSjVHRDBUVmRxb25rQUgyZjBiejhmSkVkdGd5Vkp2KwowWVROZjFQcXVJczlXb3kzcFNjeG9ERU9Za3Yyd29aR3hLNzN6WEFjN09MdEtvUnh5VUVYaFN1eDdpOXgwTGFlClRsbWhBb0dBTjBXUkZKTk56WTNiL25YR3FqUVBwVFNEd2dEMjRUQWtMbHgwNmY4TnhLazVHRHFxOWcvQWJDeTEKZUdQcGFQK05KUXYvZy84QTk0V0p4c0JuaW83blY3cWNDR21BL2lXM0FSa1VjRm50T0Y5SkpNMC9LU25IWUR5dApYQlgxVFdiZk9LUW5hUGtoTmtHRS9oZCtEVW9oQjE5cjk0K3RrYzBBQ0JUTkozK0k2Z0U9Ci0tLS0tRU5EIFJTQSBQUklWQVRFIEtFWS0tLS0tCg==
- kmsKeyName: "projects/magento2-269418/locations/global/keyRings/magento-web-secrets/cryptoKeys/magento-webserver-cert"
  secretEnv:
    SSL_CRT: CiQAw4sRuTHhD8HpGhA8bdQS8UYOrQZjKxDUkbZFC5OcMtPB5UsSYADRjCZ/IHa7n8G5kI5lEWob9CJbUfqcJw0g5OVEVkAjc5L2I8Rx93kijcs++H1oWn+yhdjYv0yT2EYB0n7W8Oje79p1ZCf79QSwAunhKgYFhccUsBUrHyY+QGQKSYTLaQ==
- kmsKeyName: "projects/magento2-269418/locations/global/keyRings/magento-web-secrets/cryptoKeys/magento-webserver-pem"
  secretEnv:
    SSL_PEM: CiQAmlC+DSjiaWEuPxB702MvQEM85cRXRM4Viw5JNrRTPmh6TNASXACJnZ61D477HH4U9jcJubu7pSXjumdXCHXZ9KdVtBgCV5lWJZaBoG4SAKK4seWiMNq+p/ZUm9+06MQGi7iVxTIdtRxMzCT3qtQrfn03hya4ZLjR9i4MwnbHqWrd
