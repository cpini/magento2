steps:
- name: 'gcr.io/cloud-builders/docker'
  entrypoint: 'bash'
  args: [
    '-c',
    #'docker build -t eu.gcr.io/$PROJECT_ID/magento2-apache24:latest -f k8s-config/apache-docker/Dockerfile --build-arg WEB_SSL_KEY=$$SSL_KEY --build-arg WEB_SSL_CRT=$$SSL_CRT --build-arg WEB_SSL_PEM=$$SSL_PEM .'
    'docker build -t eu.gcr.io/$PROJECT_ID/magento2-apache24:latest -f k8s-config/apache-docker/Dockerfile --build-arg WEB_SSL_CRT=$$SSL_CRT .'
    ]
  #secretEnv: ['SSL_KEY','SSL_CRT','SSL_PEM']
  secretEnv: ['SSL_CRT']
- name: 'gcr.io/cloud-builders/docker'
  args: ['push', "eu.gcr.io/$PROJECT_ID/magento2-apache24:latest"]
images: ["eu.gcr.io/$PROJECT_ID/magento2-apache24"]

# echo -n $path_to_enc_file | gcloud kms encrypt --plaintext-file=- \
#   --ciphertext-file=- --location=global --keyring=$keyring-name \
#   --key=$key-name | base64
secrets:
# - kmsKeyName: "projects/magento2-269418/locations/global/keyRings/magento-web-secrets/cryptoKeys/magento-webserver"
#   secretEnv:
#     SSL_KEY: CiQAwLhXnYlnR9B+OjcU1r49DF8VqzIQDgWEZayVwSYtzGjkCpASYADjhmPvdzQE1zmvxQTZA2scCqmWaiwNDZQtin0JfCpE+JxUmzK90+xlYcpcpCyD0s5LSYXQGRTzNqV4+5pno7+ERmfRPR7QLR4gbjRmzsGInQLmcyeFeNJwV/zmHh2pwg==
- kmsKeyName: "projects/magento2-269418/locations/global/keyRings/magento-web-secrets/cryptoKeys/magento-webserver-new-cert"
  secretEnv:
    SSL_CRT: CiQA4UGEtCfaDr0tTpcaC0BMFFCIxwXtkDDEF767nkDb5YeLy3QS+wkAwGvbDnkfp45HttbwCmCZgIuK4Rb1/Sf/xAEzeRO2VFyl7iB9PY6Aqx4jWjGmUzBnhbrCXGSnaJ9AIJLdDzMEc++Y64NuIhW2uk6/b36aATybgwGzg8kw2oJ8vcg4OzarGJXR/967v8WVVwuiVV1w3nrVSp+L2vefuLf3fPKPWe/52/vBg7ZWmDpzbnzYJ7ppiwCvmDlAYfl1XeSw+JuWBj0z8DCiipGSWlJ0Wj7KolD010Wn+y6elcDcpMZOyVMe4H/K+EzBXstiDfwHoNT3TVhGKRNS0aDxynq4xb9nP/a87zlx4zgyYOOvCUuAplIKqXT96L9phF0EDTak7EhnizKpe/fROGIHUChOTOCEOXVgB3dwuYOwIIb0dAqhUpTue3PnTlDNIGif49Pnv3SO6uBG2EtL8VSqIFe3Do6IdL2bh8Yttw0fJFpjMpRPv8W8K7875HvVebxiuLwRIos12+maW4OGDwGRL9A7SxhMWbVFM0r2jaEr0ST5Na8Jnrul/Cf+5FuS35y+HoTM7fzMOuhaWGlolcvHzzNYz8c5RNRnfEQ/aLrJEu+pU90t0kj1ex6HKl7T25H097jGYZkMJgxHtaXh1ZbSn5Q6PLw/vA99mypfJP6iRnukXahFOy10eLseKhre1v9ufA6NC765cXxbJd2fDbt6ymCwr/VtjE/404wal1SMbdJhjFc9qoZwbweZqzZyenZoA9gjrkrkrLBpp72CMAZzpUSyStbJaVBGf1BB1NEVA2Dxsigc6qUS2fWDtRByRFG6oMxl0vDHwucjinziXLeMZTyq/WtMnc270M/GWl2opQc8FHsEJpqwt+NpBtURFRi+ADWd4jZgP1Abf6pV+jSUXOSokWJPyBOv0qptk5077Ng/JeC1mm0Yd4TkSoYf3aLIitf2B/PByBzM95AL5eWgjFeb+XdgQdTvHGnsS2WTOrU/tV7jNTeIFSBXlEkrGr3IV1CgfE9LWmLXQHYqo6RgYqnI4PE4t7JTgGPNZKc+cywNtiawoN1xnrLKvgjxEaPpHQ4d4JrIQGB8vzxrlHO6YAg4a8cGTL5palr1nbAVo84lCMdw+K9Iza3OXLwESYs3wLPT0q4jCPfX+WQWaihKOjkz4Y1Nu7b2KUWItqfB8QqfbsN9V7AyYDyg9KiIRCQiqJXJaHaPEqwE09a/LEVRgnQlkpOTNH8S+YYq8mGZg7aSV7m5QhdPcU3sSvKhhUjSSy5tvPVqIHS/+9x/NvekfUUBgIg6p3dXVwHsDK2ymNkNx/hFG/PzIQ/aVPoFwesbQnK9/iD3vxhaeV4ctoY+hl4507dojn7GY1kW1WsQOgEg+Q3po6UppXms0u3U8SZxRfiIHD3w25TluK92Hfg9TS0J8PXA2ZQn8d7Qw1Nz0z8BY1+Ja0euXu2hJ2+IGFplEuLxzIPlIXRI+XP0G7DDG8mzHAN796bczcUk1bSKNtmoQL3Dzabi+PUGju4tJUpuE+i6I9bcuMnhVV2+TXMQv8DqKUh2rzJc18EsN45oug9zKVh9L9ZFBeszoORC4EvJF7KaGpEK58lm9TK+Q/mtogAnBvJOUj29xuUwwqvw1G0h0KKybVZOuBgNiB2tOzBOnfIwfcO3wQHmPQz0bDnbBpICquPllQFuDrYgpJ/83IveJkClVd5MtNaBdxne3YRAcVeHP7/odlrOMVbXrmtyijg=
# - kmsKeyName: "projects/magento2-269418/locations/global/keyRings/magento-web-secrets/cryptoKeys/magento-webserver-pem"
#   secretEnv:
#     SSL_PEM: CiQAmlC+DSjiaWEuPxB702MvQEM85cRXRM4Viw5JNrRTPmh6TNASXACJnZ61D477HH4U9jcJubu7pSXjumdXCHXZ9KdVtBgCV5lWJZaBoG4SAKK4seWiMNq+p/ZUm9+06MQGi7iVxTIdtRxMzCT3qtQrfn03hya4ZLjR9i4MwnbHqWrd
