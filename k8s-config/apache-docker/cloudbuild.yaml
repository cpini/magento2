steps:
- name: 'gcr.io/cloud-builders/docker'
  entrypoint: 'bash'
  args: [
    '-c',
    'docker build -t eu.gcr.io/$PROJECT_ID/magento2-apache24:latest -f k8s-config/apache-docker/Dockerfile --build-arg WEB_SSL_CRT=$$SSL_CRT .'
    ]
  #secretEnv: ['SSL_KEY','SSL_CRT','SSL_PEM']
  secretEnv: ['SSL_CRT']
- name: 'gcr.io/cloud-builders/docker'
  args: ['push', "eu.gcr.io/$PROJECT_ID/magento2-apache24:latest"]
images: ["eu.gcr.io/$PROJECT_ID/magento2-apache24"]

# echo -n $path_to_enc_file | gcloud kms encrypt --plaintext-file=- \
#   --ciphertext-file=- --location=global --keyring=$keyring-name \
#   --key=$key-name | base64
secrets:
# # - kmsKeyName: "projects/magento2-269418/locations/global/keyRings/magento-web-secrets/cryptoKeys/magento-webserver"
# #   secretEnv:
# #     SSL_KEY: CiQAwLhXnYlnR9B+OjcU1r49DF8VqzIQDgWEZayVwSYtzGjkCpASYADjhmPvdzQE1zmvxQTZA2scCqmWaiwNDZQtin0JfCpE+JxUmzK90+xlYcpcpCyD0s5LSYXQGRTzNqV4+5pno7+ERmfRPR7QLR4gbjRmzsGInQLmcyeFeNJwV/zmHh2pwg==
- kmsKeyName: 'projects/magento2-269418/locations/global/keyRings/magento-web-secrets/cryptoKeys/magento-webserver-new-cert'
  secretEnv:
    SSL_CRT: 'CiQA4UGEtO4SqkR7Ccx3ywG22nPirb+szGA57BUDUOCnsmfswWMS+wkAwGvbDlaoibgBSVv9Kr7PiPIixcOQos0+ElE6lTdxsE6haolJTurf/g08le/5oFFmUvcLeSp5t8B0DOFiXpSEdN3ZG41OkTfCI1Y9Y8Kq38hSrSmbH2FRBKwkdjlVZuKDRcEP3J1ZK97grzF5xY1snKjJO1pwxKul2vKHXiQXWtHHn/2BGvLsne/6niECpNCD0g5S948PCZjK+ELjDu44eCHz1ARuI1lMrCOPKxLyScAwcyidI06q8zdg5PZJwYsCxpVfEC9zqylx7Egc++/xEJsksLRoDFj30VePHkX04wEN1UguZaEcOc38SbdWNUQ6rwJKhXiLvnkayzVh55vhbqkgoGSRkhUWGCm5NAmAdK6V/g86Cbse5PMS6ohaAppad7XxAEJt9uLrG0QKcxLUrQqpBvYozSwdNq1qiChc+pc4cJM0iXjG25VQy/ZjH4haQPqRrtX/GlTCcQ3ag/e34CFxcNUwi7F+Sa+cVMS1dNy8dc0BxVINFt4CMKyBfsTJr4sIV9hUoZzpwnF6m9qzgVZhwdSRngRDmDdOCcCjXiIn3V22WzUI2yEFXeogye5Pzmki1giirP/v37cnPUdEAgi4s7vbdU1wvZCsvNetcaSDLpMFkSxpoiXQO+ROgymjXQpyvz/EEvcH1bbc8KtyIHk2X3xKmwWvfCdouaogf7Xf/2O3L3nBVlu0u9Q3ZoP4N2oLdeaff8qyBYt+Jmi0cNDD4UyyAuwrw60TXNHnMIcvRCAvkjK32BSbp501ZxKYG129BINcm67/fOfbE7g1rbWvk7hHqvf6I/hdIomK+xhEjwSp1xUHTBLIWfBJfTjGelCJy9IlaMiwo5BQKDYbRcCioOdhIzyLNTctHLJC7pnDjujUz53PW61HpkXwG0NPFnOJPzWt0vPJyg+ca6CEaNm/oQHkSeAsQ+WoYEcgXgLQ9OVwDHJBqgCEY9buVTIUb/bG/yz2yHg5EQdud2CxpL0EWEpnV7Gsmu15JxxSsXl6onh02Q70Ueo2UCRHzFAqasyLJWIhg+GNOxL/z5QxOIO/Oruoh7+Ya2BP2umQ1WfMXbk+XCZuhxZNMvwIjABbKmckobInukqga9L+iheC7lNCdJmA8pdjMh/qecglzqyJ34VAlS08CaxFASYVTswDqRfsgGRLBOQUrnPrfYcKjgdsybEB8F3mHCYYPl2kBOZFABPFRaihu4Mx3pvu3fNhlAXA/sLUVnvXLJLtcJOWM44QFBfzXm6pHvjsVbyMGB6/iNMqTW2pzbAxhSjg/CnjB3oaEAPMN3vGGnhfQ79cXBbechZzwrPGqPWTUV1IQMkW7DiWpfvxhSiGaMeHIiil3HwU/uDI6zxEdNI+8RjV1muGu8z4DEW2H/xnY6m+1D6PKtLo0n2lYnHI+wB7++GIR9yB7yzGbqVFGM9A3l9t///PACaSrXr2093Sl5CmXJpUz5COYBGbm2ioYZDlOVYlxy1ypK2TgfuokEbrDo647zElTLfL9Om2TGcI5pFwqsxRdNTml5rm/JRSwYBT52SvL0r7msN/n0rXL/0ivk4O6Bpm3GkH/b8mMergWl9WgPu9LiuCbOiv14KdhKEuDyoZToAcvwRJTWJPP94OsJnZ25JVA/xwU7yx2mYWuh215h3Gzr79WiNk1YDdmClLOEXjvskLut0dk23OIX/zEkCK3BFL2N8BQhbJA7E='