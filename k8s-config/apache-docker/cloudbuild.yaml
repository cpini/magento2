steps:
- name: 'gcr.io/cloud-builders/docker'
  entrypoint: 'bash'
  args: [
    '-c',
    'docker build -t eu.gcr.io/$PROJECT_ID/magento2-apache24:latest -f k8s-config/apache-docker/Dockerfile --build-arg WEB_SSL_CRT=$$SSL_CRT .'
    ]
  #secretEnv: ['SSL_KEY','SSL_CRT','SSL_PEM']
  secretEnv: ['SSL_CRT']
- name: 'gcr.io/cloud-builders/docker'
  args: ['push', "eu.gcr.io/$PROJECT_ID/magento2-apache24:latest"]
images: ["eu.gcr.io/$PROJECT_ID/magento2-apache24"]

# echo -n $path_to_enc_file | gcloud kms encrypt --plaintext-file=- \
#   --ciphertext-file=- --location=global --keyring=$keyring-name \
#   --key=$key-name | base64
secrets:
- kmsKeyName: 'projects/magento2-269418/locations/global/keyRings/magento-web-secrets/cryptoKeys/magento-webserver-new-cert'
  secretEnv:
    SSL_CRT: CiQA4UGEtL//a4GAvO9iP015Zu8H9uCzTQCZbVTTmbYNvVtn+EUS5gkAwGvbDpaMwIQIqQx0fh2sBfBrfOLdnAM3p/cMiKFl5JykeQcFR6n26wb6yPUWja2RKF5vbbSEa3NgJvnETL1C6aLYTgre600RknniZvcPCgkBsg1htlSj0zWv8N+SlRv5UiYCz3Y1bEb1OmuVXHSvE0BVa8vu9avoADqz5cYwp/ytkUsIfra6rMbsNInC10CKJALVgRydAKKobnuNx8H1tdsRNVngmfL9Iv5KU3nwL34zmegFpykxD4Ff6wJ4i1R6ogZ1jRuB6G3gIxIGQdXeKtfF3wfcfoiANi9RUMPAz/gUZ8kwJkuzrtw6m1Z1BK4oZXTGyS8ewQKUJPDjhoN/UCWesBGjtdsV47Coxrk2lzt5TTS1FqlO+2KFqtlYVqXgFPp2hObjdOJ7sa1RV5zytQRtOqdLcknRP1Wq63jhs/i53KyJLUQW4BQpe7CQQJo5Nquc/TVNxgEP346AknxNz813cRPd9FvRu6DVVoFEm62AalmGkIWGbZY22ZA4yhYyD1UoNEydDwFVk4VQOPnyB/91zJFrJGjBtiFgUSKcXVCqBVXJl4wqxtIjrKrwQfia7T6dSDFMGI3dBkrHxNbCLea26yx5jfcj2qcuOAz+kwx+pllo8lo7kZKUqmqc5Yf9oaACUVkaSqdjFdn5VdrLEA8Nq5r6JjDWOqSptGucbRx26IdwTwRBFaNzSK3AbOzph12dd5biy0fLCaThqW6WwQDcmnSCMGnnTrGzW/HjwKnrO8TlmSCWdod34HaQiANPLRm5yqgmlz3CKlcyTzhfkC53/mT7I6hLXDqC3iOkDVmmLzoq5EXVeI462dryMS3qxNnQfb+mzdJCO7iBIucvj95FCxyD0pCv87ApR6KeMRJsxCQ7R4F5IHJ/KoFraR406Jd1GapbbJG01JzBezSTh19PsuJpUfw2qxqxVb+gtRhKY64KEbUeDMRyNNjOD7YUpNyHsiJcJXs3VKzYOsx5GjMpI2eekiX626c6FA5uTNAXEkYowsOKPrVX24gAFVwUASib3Gn5NYiWFNNMIl7bsOo8ggkg76+Iko2M6kN3RHu/GzDtPU+v/TqqUQRR2rzqj1Kt6p2q3D5OvggpD8B/Z4uLAf4NDYqlLnhaD4nffjVcsAtSrEz1iqrRi1JqJKs9G6i7k2MmC/uRHBmP1ugmV7Qrx+J0TmVyty07lgJZ+azk/OwrA6iYs9pTGwsYgsCgoitffqH3hMMKGp9dCRa51eWvGltIRDEeSR1NgG9ZryzzD+bMU21MxqiirnFvuejXrdbthbUTdajTf8wwfOCFXBVwiRpk+5U+qV70uicK9kxKazWm7sWXgdUU7F7cFF5r/fUbQk3LyIUg2LBRqZbda5SWFtvVhrHBu8xqc5A7rwrDzt3Vr0S1LnYLs7qxCJNnW5KXzaB0wFBDH+uzbenIn/wZphKP1qN77la2hgq+ZQyuHoLFNShzUWqhLYpTjAn09eIXAfQdacSUBBGGdwB/yCFv/uHqoFcGPkB9r5KrXRbgNP7fF0hvAUST0zEIFVqgEbudWjkJtDWNTYnh2lJOe7G2NWXU7at5F1eme+NBhm3eklsCdfy2ZlopXpkEZkk79w+qQvMookacfkJ7T89R1RvMJJZN97fiA7NmrdZkzIVncDPeH3TxnxAS2rpsFAwePj5levA=