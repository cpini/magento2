steps:
- name: 'gcr.io/cloud-builders/docker'
  entrypoint: 'bash'
  args: [
    '-c',
    'docker build -t eu.gcr.io/$PROJECT_ID/magento2-apache24:latest -f k8s-config/apache-docker/Dockerfile --build-arg WEB_SSL_CRT=$$SSL_CRT .'
    ]
  #secretEnv: ['SSL_KEY','SSL_CRT','SSL_PEM']
  secretEnv: ['SSL_CRT']
- name: 'gcr.io/cloud-builders/docker'
  args: ['push', "eu.gcr.io/$PROJECT_ID/magento2-apache24:latest"]
images: ["eu.gcr.io/$PROJECT_ID/magento2-apache24"]

# echo -n $path_to_enc_file | gcloud kms encrypt --plaintext-file=- \
#   --ciphertext-file=- --location=global --keyring=$keyring-name \
#   --key=$key-name | base64
secrets:
- kmsKeyName: 'projects/magento2-269418/locations/global/keyRings/magento-web-secrets/cryptoKeys/magento-webserver-new-cert'
  secretEnv:
    SSL_CRT: CiQA4UGEtB0Gr9+8oGAi0oo93lSsdzH/YJZMlCzhGgDUfWLPPhgS+wkAwGvbDiECqiiUGh9ZIxdF
LdNSgFHmKFzc9n0S8bbngzLs9AGd3lD6OE2yEgNv8EjQ4B01hMoA4b1CPzOt59uJS8svFbSYN8jG
sQvUzrEAHRzIWGHVFtzA5zxBHXfCH9rXcIkNdPmPAWnOqhzlSQMBhWbQe6cXZxpRmZ4+iPam/hhZ
ghLXHeQ0QBPQbTMvydhq9wGA7j/I0Xinf84vTqycgmquUwIvCJmXv0FAEhAydtaDIMNHIHQFSvAq
rY2FmCLrBjykyUiGfZ+QngArX80E92Esylo+BKcmG2j0qffJcEfl9VZwbRMIZaVrEHoW3fSxRt5/
FL0lqXE+gaZof3PRuSYMBPgFNWgNboSUq+P5Q1vkdMFLTvWOkEvZSJl8wgDxoclwvpJGAnFAqcpT
uaZIDR2j/FkE/P8FducKUsU7y1WqA4/SQYyR6ojmW9uzjTgNzXC+kx896CUtqvq0+UKLfwVANouP
YnfHwxiqc+IoUarKVrcRDwNIdTLUy9/9HT1bMEDhJpPeUtGLKuTeRTtCHUIU1QpexGRAbxpx60tu
XANNe3Jkf/s4up9ZWpyMei/5PblYKbe6TlANCgcjRgZm+i0zgn3nMBKNgF6O0o8yTZ9O61W96chq
nSgiQ0FuU4AAhSBdfJqIZZQs/ADLYdiy9a4JQzdWrr53spaG7wJqKN5ALXMsjf9xMdg2Gl7zkqyL
RVKbTbYPToCKdN74t2XPJ7PaPN03IZ15wERZ066J1XSzcolUpZhnLLH5uZtp4QGLM8xmbAvkicXv
CfW31CK8kScjPSQFU0feiWDgHHQcCKVhICXtUM2JhErcSF90qI4fugupZZ+y4BIb30kePosmgsgn
AtMVVv7f02sT5sMI4TljyQbGrTAeDbTC7LXUIVYnLJkHOBQD8a+mH42IcsswI1tXI1eg4Byne/eQ
VWMM9/HFGRKpcLtmholZH6foQN7f2G94xdRZ1jpfUNa1HYQ5m0HeB96LTU0KFvyKol5XaMwAZ4kK
XxFC2kFiThXORcvdwv11GhDlqM1y0VjfLFra7G/fxosiRHJ21Isd2FDHUggR6LckRkWphwGRPudp
IJk7lclCORZF7o67vH+9XBiwZmu5hWEVOMOkNnshSWiZPGde7AUJw0iJXTxN7+lbNKIAxEM02gDw
pN6l9zwcP3nNUw9CjcQozCHmHZn1gIAKGnUdXfjKgUEe++EEIDJDocCbi0B1r1/YYvDtywlxIMvn
9y9lq4BsflGBuAr47cmp/vnFruhEplQUI3tAlPtb4Ucpd4Yn2VOv7cM1TkKIHNJNxwnhnboi1RQv
f3gxWJBtihe+X6vI1NNFsE3Ze5W3Mju0MEnwAIj8cL5GVT1nYvORWxUfE97ZdutHB1xDzieYZEQe
RMNMM/AU0lkEDG/LhLskKA0eal4hhsZLm6WUAdwkzZTCP9JGzoNBHKNOb9jP18x68LzQ93pXX7h3
k6bw2kEMn9sAowB1KCjOwWduCbWXhNTM6OUex7YJ9eSEjth6Sx0Ot7ykuKPKCdTqGv249BOAXVqj
+xQyMR1LzXgE3LOS/Pek55j2vPf7dUm26yERklfBmqnhjrpO5OZoPniQYkt/dHg2JZQcOAW98JOn
m290Hk28rzwkJwJGkdqAVcQM7SaylSHAHO0jzbDXCvh7PvPUHob0E+vdLe7uq1z3130cbpW43rNt
ZvQaVIA=