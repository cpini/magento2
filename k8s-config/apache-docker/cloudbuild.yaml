steps:
- name: 'gcr.io/cloud-builders/docker'
  entrypoint: 'bash'
  args: [
    '-c',
    'docker build -t eu.gcr.io/$PROJECT_ID/magento2-apache24:latest -f k8s-config/apache-docker/Dockerfile --build-arg WEB_SSL_CRT=$$SSL_CRT .'
    ]
  #secretEnv: ['SSL_KEY','SSL_CRT','SSL_PEM']
  secretEnv: ['SSL_CRT']
- name: 'gcr.io/cloud-builders/docker'
  args: ['push', "eu.gcr.io/$PROJECT_ID/magento2-apache24:latest"]
images: ["eu.gcr.io/$PROJECT_ID/magento2-apache24"]

# echo -n $path_to_enc_file | gcloud kms encrypt --plaintext-file=- \
#   --ciphertext-file=- --location=global --keyring=$keyring-name \
#   --key=$key-name | base64
secrets:
# # - kmsKeyName: "projects/magento2-269418/locations/global/keyRings/magento-web-secrets/cryptoKeys/magento-webserver"
# #   secretEnv:
# #     SSL_KEY: CiQAwLhXnYlnR9B+OjcU1r49DF8VqzIQDgWEZayVwSYtzGjkCpASYADjhmPvdzQE1zmvxQTZA2scCqmWaiwNDZQtin0JfCpE+JxUmzK90+xlYcpcpCyD0s5LSYXQGRTzNqV4+5pno7+ERmfRPR7QLR4gbjRmzsGInQLmcyeFeNJwV/zmHh2pwg==
- kmsKeyName: "projects/magento2-269418/locations/global/keyRings/magento-web-secrets/cryptoKeys/magento-webserver-new-cert"
  secretEnv:
    SSL_CRT: CiQA4UGEtL7H5/fTkUuphKmXBmH8bo5AHmhzHTdxoqCiLexQTPAS+wkAwGvbDjfKaBIxbYkdrGq5TCXoapk+P9Q/9OxLuUCn+T4pze9556f2toreoTOZFr+oVMJVqmzaca/QE00U9F3yDZOy3SKNFnOkqtcRx4jcimuYBM9JsF6kN2jwH2roSkKmvkBvDUEnL49pJ5GN/KQrjRCiSMW3ZHfBkJ5J+9rIOk5m5e013L4Cl6LC3Eocv5RytIz1tez+D+yQgxVSafoF2OxTGcm3BXjrp72ksOvBNIKNsvKtQFwyZmM/boHCyTepKCXNati/5hKxyONOIF6WxFsDWsnnkw4Kk+5CEEaTAzNrIsfH9iqABLL9uumEEikyfmE474cZIfR3daIYHziGX0MYezst0SjcjGUrH4dmVsAh8lXx4spGAjMeBliBmKaRto10ersjZ9E39haRR1WtAZpEt+bzQiBPWkyPLGnvodZ466yJM5COcpp19sK46fGXf4Ub0/WQg6+96nkf6Kp4uu/58Yf1tsQwNV3xYhnwaxmFPyYMo9F7KR9vgkualoZlgejESmXQTOqQVlZQch2Ozk5tc2kvK5AP79FLBzaCC0NDtE+5D+VzQ/ceBvxs/kJrXJ8wB4EU1KxEwbTQS1e/9o8SCvD8Ntub0wuOy5TEJfnDBfHpoZXfidISeWH3EoML/oVrJOd07y7W/h6EqHQyWNN6vGadQWtyNtJEVqtF516L4+C1P9ALsjaEx6qzXq7VfzLfj+IhVodIXu62AbZ1l0UTNDpWi4+Xg3KCQY4CyDatY/Q42I7dfxh4JDvgV5Cd33tiUXaZOHdkp0RfBGyTgK6foRvat7Ks89wWgp6Dv13I8lvk+39BXutCp0Wf0MZfU0tQEq1SaSWg+j7WUC2ylSwwIFyu8OTdwex1ktnRDMaG/mAmmlEUumDRhScomZVp8rXOwskguQThY5IizRl827KIgjD2DwTQQyMBuWFWN0lvfZPXTmwa46aLL6F/r04CvfoZI3YtW6+Jt9fTdhkP4N2jmD2dEBxlrpV+OKzSEvClPJq0DCvGk9yRixlAh32/PHA99BaMJFggfL55yU2tqodmfYCxXJvhyOTroWM+GuOfdHv+gM9nkIOhdIZOb1z3wxdWR2uv1vWrq70AXPp4sJNKu7HsErOK8O+QqTPB7t6QULlt+My36ArGgNaK1uZqX8lutB6mD5n0nzdGrcyO7xykFFF6p18QrB2U6+1+cxKmi4y+JchLxtqkmspbtlXZgKy3mGf3dj6Y9jzQ4smLgavlxqhw49jj6kxE/1VaYLYYtrcK3E+UvzkN6/+Vq7T2hAOM8PsYuQ15EfSUDYU2fXcVdFqG9FIrk+Z2xnOD8xjTZTJE9mAyiKFlFi+LrirVBOE8XjpL5+VYx9TQyivzPdOah24yuOu2T1CJnfq1Z4qz5WrijOqLUZZ/1P6NMOO4qr8NOLXWzd4hNbD8b0tT/tpiE1IB7Maq5MUgnrlk3PonAIQkVN6ONbhyoRuFGIUCWmodtbEBQjDqQ1+MW+V7g+w8JeyddsowyXgPcTtUBuCmMF1syiwtdvD11PxPUx4LgSqow+g/dP7EsU77HZjfjUporc9OawGtFPA/t3ocgMSOTqkhrN6HjN14lqV/f+zGwtPL+feINJL0wiNpxHlBEYpcC9GX1V49PIQaIRuHymU6gKyPBzNunFhMtavkhI8AKMzsjYOuimnvBOXzI6JnuDvz6SDKKL5LHwI=